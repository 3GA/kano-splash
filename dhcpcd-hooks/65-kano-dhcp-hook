#
# 65-kano-dhcp-hook
#
# Copyright (C) 2017 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
# DHCP hook script to prepare Kano OS settings when network comes up
#
# To enable this hook for logging, edit /etc/dhcpcd.conf and add the key "env DHCP_LOG=1"
# Reboot, and tail the logfile locally to follow the events.
#

# logfile used in log mode
logfile="/tmp/kano-dhcp-hook.log"

# file that external applications can monitor for internet availability triggers
monitor_file="/var/opt/internet_monitor"

# logfile used in log mode
logfile="/tmp/kano-dhcp-hook.log"

# file that external applications can monitor for internet availability triggers
monitor_file="/var/opt/internet_monitor"

case "$reason" in
REBOOT)
    echo "internet: up" > $monitor_file

    ip_addr=`ip addr show wlan0 | grep inet | awk '{print $2}' | sed -s 's/\/.*//')`
    echo "ipaddr: $ip_addr" >> $logfile

    systemd-run /usr/bin/kano-sentry-startup $reason
    systemd-run /usr/bin/kano-set-system-date $reason

    systemd-run /usr/bin/kano-network-hook $reason
    systemd-run /usr/bin/kano-dashboard-sysupdates "bound" "$ip_addr"
    ;;
esac

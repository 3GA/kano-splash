#!/bin/sh

# kano-shutdown
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
# Script to shutdown the system after a confirmation message
# The user executing this code needs sudo NOPASSWD: privileges for /sbin/poweroff.
#

# Check if the updater scheduled the install at shutdown
STATUS_FILE="/var/cache/kano-updater/status.json"
scheduled=`grep -Po '"is_scheduled":.[0|1]' $STATUS_FILE | awk '{ print $2 }'`

if [ $scheduled -eq 1 ]
then
    sudo kano-updater install --gui
fi

# Report shutdown event to Kano Tracker
kano-tracker-ctl +1 shutdown

kano-sync --backup -s &
lxsession-logout -p "Logout from this session?" -b /usr/share/kano-desktop/images/kano-logout-face.png -s top

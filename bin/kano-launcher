#!/bin/sh

# kano-launcher
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
# A simple script to launch Kano projects
# Usage: kano-launcher cmd [preset]

# Make sure there are no other projects running at the same time
killall_projects () {
    if [ "$(id -u)" != "0" ]; then
        # obtain list of processes to avoid killing. This construction converts
        # newlines to | (except trailing ones).
        # kano-launcher is included in this list otherwise we shoot ourselves in the head.
        no_kill=$(sed ':a;N;s/\n/|/;ta; ' </usr/share/kano-toolset/kano-launcher-no-kill-list)
        # search command lines for these pids and attempt to kill all the others.
        pgrep  -f -v "($no_kill)"  |xargs kill
    fi
}


if [ "$2" != "pcmanfm" ]; then
    killall_projects
fi

if [ -z "$1" ]; then
    exit 1
fi

eval "$1 &"

# Apply window presets
case "$2" in
    make-snake)
        kano-window-tool -t "Make Snake" -dyes -m -f
        ;;
    pcmanfm)
        if [ -e /usr/bin/kano-profile-cli ]; then
            kano-profile-cli increment_app_state_variable pcmanfm starts 1
        fi
        ;;
esac

exit 0
